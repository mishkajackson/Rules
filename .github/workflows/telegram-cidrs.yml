name: Update Telegram CIDR Lists

on:
  workflow_dispatch: # Allows manual trigger
  schedule:
    - cron: '0 3 * * *' # Runs daily at 3 AM UTC

jobs:
  update-cidr-lists:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Telegram CIDR list
        run: |
          curl -s https://core.telegram.org/resources/cidr.txt -o cidr.txt

      - name: Create Clash Telegram.yaml
        run: |
          mkdir -p Clash/IPs
          echo "payload:" > Clash/IPs/Telegram.yaml
          cat cidr.txt | sed 's/^/  - /' >> Clash/IPs/Telegram.yaml

      - name: Create Shadowrocket Telegram.list
        run: |
          mkdir -p Shadowrocket
          # Initialize empty file
          > Shadowrocket/Telegram.list
          
          # Process IPv4 addresses
          grep -v ':' cidr.txt | while read -r line; do
            echo "IP-CIDR,$line,no-resolve" >> Shadowrocket/Telegram.list
          done
          
          # Process IPv6 addresses
          grep ':' cidr.txt | while read -r line; do
            echo "IP-CIDR6,$line,no-resolve" >> Shadowrocket/Telegram.list
          done

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add Clash/IPs/Telegram.yaml Shadowrocket/Telegram.list
          git commit -m "Update Telegram CIDR lists" || echo "No changes to commit"
          git push